# /etc/nginx/sites-available/erm.selu.edu.conf (or /etc/nginx/conf.d/erm.selu.edu.conf)

server { # Listen on port 443 for HTTPS traffic
    listen 443 ssl; # managed by Certbot

    server_name erm.selu.edu; # The domain name for this virtual host

    # Root directory (serves from Completed folder in production)
    root /usr/share/nginx/html/www/humanitiesonline/Ruskin;
    index index.php index.html index.htm;
    charset utf-8;

    # SSL Certificates (Certbot)
    ssl_certificate /etc/letsencrypt/live/erm.selu.edu/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/erm.selu.edu/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

    # Logging
    access_log /var/log/nginx/erm.selu.edu_access.log;
    error_log  /var/log/nginx/erm.selu.edu_error.log;

    client_max_body_size 210M;
    autoindex on; # Consider disabling in production

    # Set default content type once
    default_type text/html;

    # Favicon
    location = /favicon.ico {
        alias /usr/share/nginx/html/www/humanitiesonline/Ruskin/_Resources/images/ruskin_icon.png;
    }

    # Static file types
    location ~* \.xml$ { default_type application/xml; }
    location ~* \.css$ { default_type text/css; }
    location ~* \.js$  { default_type application/javascript; }

    # Fonts with CORS
    location ~* ^/_Resources/fonts/(.+\.(woff|woff2|eot|ttf|otf))$ {
        alias /usr/share/nginx/html/www/humanitiesonline/Ruskin/_Resources/fonts/$1;
        access_log off;
        add_header Access-Control-Allow-Origin *;
        default_type application/font-woff;
    }

    # Resources alias
    location /_Resources/ {
        alias /usr/share/nginx/html/www/humanitiesonline/Ruskin/_Resources/;
        autoindex on;
    }

    # HTML injection and fallback
    location ~* \.html$ {
        charset utf-8;
        gzip off;
        sub_filter_types text/html;
        sub_filter_once off;
        sub_filter '<main' '<link rel="icon" type="image/png" href="/_Resources/images/ruskin_icon.png"><link rel="stylesheet" href="/_Resources/css_styles/site_styles.css"><main';

        try_files $uri $uri.html
                  /gen/_xml/_Completed$uri.html
                  /gen/_xml/_In_Process$uri.html
                  /gen/_xml$uri.html
                  =404;
    }

    # PHP processing and HTML head injection
    location ~ \.php$ {
        include fastcgi_params;
        fastcgi_pass unix:/run/php-fpm/www.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param DOCUMENT_ROOT $document_root;

        sub_filter_types application/x-httpd-php text/html;
        sub_filter_once off;
        sub_filter '<?php' '<?php echo \'<link rel="icon" type="image/png" href="/_Resources/images/ruskin_icon.png">\';';
    }

    # Homepage
    location = / {
        try_files /gen/_xml/_Completed/webpages/homepage.html =404;
    }

    # Search PHP routes
    location = /search.php {
        fastcgi_pass unix:/run/php-fpm/www.sock;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root/src/search_new/search.php;
        fastcgi_param DOCUMENT_ROOT $document_root;
    }

    location = /search_handler.php {
        fastcgi_pass unix:/run/php-fpm/www.sock;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root/src/search_new/search_handler.php;
        fastcgi_param DOCUMENT_ROOT $document_root;
    }

    location = /autocomplete_handler.php {
        fastcgi_pass unix:/run/php-fpm/www.sock;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root/src/search_new/autocomplete_handler.php;
        fastcgi_param DOCUMENT_ROOT $document_root;
    }

    # HTML folders with fallback and injection
    location ~* ^/(apparatuses|glosses|letters|notes|webpages)/([^/]+)(\.html)?$ {
        try_files /gen/_xml/_Completed/$1/$2.html
                  /gen/_xml/_In_Process/$1/$2.html
                  /gen/_xml/$1/$2.html
                  =404;

        sub_filter_types text/html;
        sub_filter_once off;
        sub_filter '<main' '<link rel="icon" type="image/png" href="/_Resources/images/ruskin_icon.png"><link rel="stylesheet" href="/_Resources/css_styles/site_styles.css"><main';
    }

    # PHP fallback routes
    location ~* ^/(witnesses|figures|corpuses)/([^/]+)$ {
        try_files /gen/_xml/_Completed/$1/$2.php
                  /gen/_xml/_In_Process/$1/$2.php
                  /gen/_xml/$1/$2.php =404;

        fastcgi_pass unix:/run/php-fpm/www.sock;
        include fastcgi_params;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root/gen/_xml/_Completed/$1/$2.php;
        fastcgi_param DOCUMENT_ROOT $document_root;
    }

    location ~ ^/(Corpuses|Figures|Witnesses)/(.+\.php)$ {
        try_files /gen/_xml/_Completed/$1/$2
                  /gen/_xml/_In_Process/$1/$2
                  /gen/_xml/$1/$2 =404;

        fastcgi_pass unix:/run/php-fpm/www.sock;
        include fastcgi_params;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root/gen/_xml/_Completed/$1/$2;
        fastcgi_param DOCUMENT_ROOT $document_root;
    }

    # Final fallback
    location / {
        try_files $uri $uri/ $uri.html $uri.html/
                  /gen/_xml/_In_Process$uri
                  /gen/_xml/_In_Process$uri.html
                  =404;
    }
}


# Redirect all HTTP traffic to HTTPS
server {
    if ($host = erm.selu.edu) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    listen 80;
    server_name erm.selu.edu;
    return 404; # managed by Certbot
}
[adhamala@erm conf.d]$ cat erm.selu.edu.conf
                       exit
logout
Connection to 192.168.32.15 closed.
userselu@SU2208D00092282 ~ % ssh adhamala@192.168.32.15/etc/nginx
ssh: Could not resolve hostname 192.168.32.15/etc/nginx: nodename nor servname provided, or not known
userselu@SU2208D00092282 ~ % ssh adhamala@192.168.32.15          
Last login: Wed Jul 30 15:59:40 2025 from 172.25.0.11
[adhamala@erm ~]$ cd /etc/nginx/
[adhamala@erm nginx]$ cd conf.d/
[adhamala@erm conf.d]$ ls
erm.selu.edu.conf  erm.selu.edu.conf.new  php-fpm.conf
[adhamala@erm conf.d]$ touch erm.selu.edu.search
touch: cannot touch 'erm.selu.edu.search': Permission denied
[adhamala@erm conf.d]$ touch erm.selu.edu.old
touch: cannot touch 'erm.selu.edu.old': Permission denied
[adhamala@erm conf.d]$ ls
erm.selu.edu.conf  erm.selu.edu.conf.new  php-fpm.conf
[adhamala@erm conf.d]$ touch erm.selu.edu.conf.search
touch: cannot touch 'erm.selu.edu.conf.search': Permission denied
[adhamala@erm conf.d]$ vi erm.selu.edu.conf.new



server {
    listen 443 ssl;
    server_name erm.selu.edu;

    root /usr/share/nginx/html/www/humanitiesonline/Ruskin/gen/_xml/_Completed;
    index index.php index.html index.htm;
    charset utf-8;

    access_log /var/log/nginx/erm.selu.edu_access.log;
    error_log  /var/log/nginx/erm.selu.edu_error.log;

    client_max_body_size 210M;
    autoindex on;

    ssl_certificate /etc/letsencrypt/live/erm.selu.edu/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/erm.selu.edu/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location = /favicon.ico {
        alias /usr/share/nginx/html/www/humanitiesonline/Ruskin/_Resources/images/ruskin_icon.png;
        access_log off;
        log_not_found off;
    }

    location ~* \.html$ {
        default_type text/html;
        sub_filter '</head>' '<link rel="stylesheet" href="/_Resources/css/fonts.css"><link rel="stylesheet" href="/_Resources/css/digital_archive.css"></head>';
        sub_filter '<main' '<link rel="icon" type="image/png" href="/_Resources/images/ruskin_icon.png"><link rel="stylesheet" href="/_Resources/css_styles/site_styles.css"><main';
        sub_filter_once off;
    }

    location ~* \.xml$ {
        default_type application/xml;
    }

    location ~* \.css$ {
        default_type text/css;
    }

    location ~* \.js$ {
        default_type application/javascript;
    }

    location /_Resources {
        alias /usr/share/nginx/html/www/humanitiesonline/Ruskin/_Resources;
    }

    location = / {
        try_files /webpages/homepage.html =404;
    }
                                                                                                                                                         1,1           Top
